ä»‹ç»babelï¼šhttps://github.com/yjwSurCode/babel-plugin#readme

1ï¼šè¯­æ³•åˆ†æ----è¿™ä¸ªé˜¶æ®µè¯­æ³•è§£æå™¨(Parser)ä¼šæŠŠTokensè½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘(Abstract Syntax Treeï¼ŒAST)
2ï¼šç¼–è¾‘AST,æ¥ç€å°±æ˜¯è½¬æ¢(Transform)äº†,è½¬æ¢é˜¶æ®µä¼šå¯¹ AST è¿›è¡Œéå†ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œå¢åˆ æŸ¥æ”¹ã€‚Babel æ‰€æœ‰æ’ä»¶éƒ½æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µå·¥ä½œ, æ¯”å¦‚è¯­æ³•è½¬æ¢ã€ä»£ç å‹ç¼©ã€‚
3ï¼šæœ€åé˜¶æ®µè¿˜æ˜¯è¦æŠŠ AST è½¬æ¢å›å­—ç¬¦ä¸²å½¢å¼çš„Javascriptï¼ŒåŒæ—¶è¿™ä¸ªé˜¶æ®µè¿˜ä¼šç”ŸæˆSource Mapã€‚
(AST: å®ƒå°±æ˜¯ä¸€æ£µ'å¯¹è±¡æ ‘'ï¼Œç”¨æ¥è¡¨ç¤ºä»£ç çš„è¯­æ³•ç»“æ„ã€‚)

babelåˆæ­¥äº†è§£ï¼šhttps://zhuanlan.zhihu.com/p/352878760

npm install --save-dev @babel/core @babel/cli @babel/preset-env

1ï¼šBabel è‡ªå¸¦äº†ä¸€ä¸ªå†…ç½®çš„ CLI å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯é€šè¿‡å‘½ä»¤è¡Œç¼–è¯‘æ–‡ä»¶

æ¶æ„å’ŒåŸç† + å®æˆ˜ï¼ˆhttps://juejin.cn/post/6844903956905197576#babel-%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8Bï¼‰


babelçš„å¸¸ç”¨æ’ä»¶ï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼š
@babel/plugin-proposal-class-properties
(è¯¥æ’ä»¶å¯ä»¥è®©ä½ åœ¨ç±»ä¸­ä¹¦å†™åˆå§‹åŒ–å­—æ®µ)

@babel-plugin-transform-remove-console
ï¼ˆæ‰“åŒ…åç§»é™¤console.logï¼‰

@babel/plugin-transform-runtime
ï¼ˆè¯­æ³•è½¬ç åç”Ÿæˆçš„ä»£ç  æœ‰å¤ªå¤šå†—ä½™çš„ä»£ç ï¼Œæ’ä»¶å¯ä»¥æŠŠé‡å¤çš„å‡½æ•°å£°æ˜ä»£ç é›†ä¸­åœ¨ä¸€ä¸ªæ–‡ä»¶ï¼‰

@babel-plugin-import
(ç»„ä»¶åº“æŒ‰éœ€å¯¼å…¥--åœ¨babelè½¬ç çš„æ—¶å€™ï¼ŒæŠŠæ•´ä¸ªåº“â€˜antdâ€™çš„å¼•ç”¨ï¼Œå˜ä¸ºâ€™antd/lib/buttonâ€™å…·ä½“æ¨¡å—çš„å¼•ç”¨ã€‚è¿™æ ·webpackæ”¶é›†ä¾èµ–moduleå°±ä¸æ˜¯æ•´ä¸ªantdï¼Œè€Œæ˜¯é‡Œé¢çš„button)ã€‚

@babel/plugin-proposal-function-bind
(è¯¥æ’ä»¶å¯ä»¥è®©ä½ è½»æ¾çš„ä¸ºæŸä¸ªæ–¹æ³•ç»‘å®šthis)

example:
function Print() {
    console.log(this.loginId);
}
const obj = {
    loginId: "abc"
};
obj::Print(); //ç›¸å½“äºï¼šPrint.call(obj);

exampleï¼š
plugins: [
      react({
        babel: {
          plugins: [
            [
              'import',
              {
                libraryName: 'fnx-ui',
                libraryDirectory: 'es',
                style: true,
              },
            ],
          ],
        },
      })]

core-js polyfillçš„ç±»åº“
ï¼ˆcore-js æ˜¯babel-polyfill çš„åº•å±‚ä¾èµ–ï¼‰

ä»£ç æ¡ˆä¾‹æ¼”ç¤ºï¼šhttps://astexplorer.net/#/KJ8AjD6maa


Webpackï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼š

Webpackæ˜¯ä¸€ç§å‰ç«¯èµ„æºæ„å»ºå·¥å…·ï¼Œä¸€ä¸ªé™æ€æ¨¡å—æ‰“åŒ…å™¨
(å°†å„ç§ç±»å‹çš„èµ„æºï¼ŒåŒ…æ‹¬å›¾ç‰‡ã€cssã€jsç­‰ï¼Œè½¬è¯‘ã€ç»„åˆã€æ‹¼æ¥ã€ç”Ÿæˆ JS æ ¼å¼çš„ bundler.jsæ–‡ä»¶,è½¬æ¢æˆä¸ºæµè§ˆå™¨å¯è¿è¡Œçš„ä»£ç )
ä»£ç è½¬æ¢: TypeScript ç¼–è¯‘æˆ JavaScriptã€SCSS,LESS ç¼–è¯‘æˆ CSS.
æ–‡ä»¶ä¼˜åŒ–ï¼šå‹ç¼© JavaScriptã€CSSã€HTML ä»£ç ï¼Œå‹ç¼©åˆå¹¶å›¾ç‰‡ã€‚
ä»£ç åˆ†å‰²ï¼šæå–å¤šä¸ªé¡µé¢çš„å…¬å…±ä»£ç ã€æå–é¦–å±ä¸éœ€è¦æ‰§è¡Œéƒ¨åˆ†çš„ä»£ç è®©å…¶å¼‚æ­¥åŠ è½½ã€‚
æ¨¡å—åˆå¹¶ï¼šåœ¨é‡‡ç”¨æ¨¡å—åŒ–çš„é¡¹ç›®é‡Œä¼šæœ‰å¾ˆå¤šä¸ªæ¨¡å—å’Œæ–‡ä»¶ï¼Œéœ€è¦æ„å»ºåŠŸèƒ½æŠŠæ¨¡å—åˆ†ç±»åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ã€‚
è‡ªåŠ¨åˆ·æ–°ï¼šç›‘å¬æœ¬åœ°æºä»£ç çš„å˜åŒ–ï¼Œè‡ªåŠ¨é‡æ–°æ„å»ºã€åˆ·æ–°æµè§ˆå™¨ã€‚

8ä¸ªé…ç½®:
mode æ¨¡å‹-------development production
entry å…¥å£
outputè¾“å‡º
1. pathï¼šæœ€ç»ˆäº§ç‰©æ‰€åœ¨ç›®å½•
1. filenameï¼šäº§ç‰©æ–‡ä»¶å‘½åè§„åˆ™
1. chunkFilenameï¼šchunkæ–‡ä»¶å‘½åè§„åˆ™
1. publicPathï¼šå…¬å…±ç›®å½•è·¯å¾„ï¼Œç”¨äºæŒ‡å®šç‰¹å®šçš„æ–‡ä»¶æŸ¥æ‰¾è·¯å¾„

devtoolå¼€å‘å·¥å…·

devServerå¼€å‘æœåŠ¡å™¨------------webpack-dev-server  hotçƒ­æ›¿æ¢

optimizationä¼˜åŒ–

moduleæ¨¡å—
é’ˆå¯¹ä¸åŒçš„æ–‡ä»¶ moduleé‡Œé¢å¯ä»¥é€šè¿‡ä¸åŒçš„loaderæ¥å¤„ç†
rules:{ test include exclude use }åœ¨å…¶ä¸­é…ç½®ä¸åŒç±»å‹æ–‡ä»¶æ‰€ä½¿ç”¨çš„ä¸åŒloaderï¼Œä¾‹å¦‚æŸäº›loaderå¯ä»¥å°†reactçš„ä»£ç åŠå…¶ä¾èµ–è‡ªåŠ¨å˜æˆä¸€ä¸ªjsæ–‡ä»¶
egï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼š
module{
rulesï¼š:[
  {
     test:/\.js$/,
     indclude:srcPath
     exclude:[/nodeModules],
     use:[
      {
        loader:require.resolve('babel-loader'),
        option:[ {presets:[require.resolve('@babe/preset-react')]} ]
      }
     ]
  }
]
}

pluginsæ’ä»¶
1. html-webpack-pluginèƒ½è‡ªåŠ¨å°†æ”¹ååçš„æ–‡ä»¶åŠ è½½åˆ°åŸå…ˆå¼•ç”¨å®ƒçš„æ–‡ä»¶ä¸­
1. DefinePluginèƒ½å°†å¸¸é‡æ’å…¥æ–‡ä»¶ä¸­


ç¤¾åŒºå›´ç»•ç€ Webpack è¡ç”Ÿå‡ºäº†å„ç§æ‰‹è„šæ¶ï¼Œæ¯”å¦‚ vue-cliã€create-react-appï¼Œumiè§£å†³â€œç”¨â€çš„é—®é¢˜ã€‚

ä¸€æ–‡åƒé€ Webpack æ ¸å¿ƒåŸç†ï¼šhttps://zhuanlan.zhihu.com/p/363928061

3:webpack è¿è¡Œæœºåˆ¶ä¸æ ¸å¿ƒå·¥ä½œåŸç† ï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼š
  é€šè¿‡ Loader å¤„ç†ç‰¹æ®Šç±»å‹èµ„æºçš„åŠ è½½ï¼Œä¾‹å¦‚åŠ è½½æ ·å¼ã€å›¾ç‰‡ï¼›
  é€šè¿‡ Plugin å®ç°å„ç§è‡ªåŠ¨åŒ–çš„æ„å»ºä»»åŠ¡ï¼Œä¾‹å¦‚è‡ªåŠ¨å‹ç¼©ã€è‡ªåŠ¨å‘å¸ƒã€‚


ä»‹ç»ä¸‹ webpack çƒ­æ›´æ–°åŸç†ï¼šï¼šï¼šï¼šï¼šï¼šï¼š
HMR Server ä½¿ç”¨webSocketé€šçŸ¥HMR runtime éœ€è¦æ›´æ–°ï¼ŒHMRè¿è¡Œæ—¶é€šè¿‡HTTPè¯·æ±‚æ›´æ–°jsonpï¼›
5.HMRè¿è¡Œæ—¶æ›¿æ¢æ›´æ–°ä¸­çš„æ¨¡å—ï¼Œå¦‚æœç¡®å®šè¿™äº›æ¨¡å—æ— æ³•æ›´æ–°ï¼Œåˆ™è§¦å‘æ•´ä¸ªé¡µé¢åˆ·æ–°ã€‚


Webpack
åŸç†ï¼šï¼šé€çº§é€’å½’è¯†åˆ«ä¾èµ–ï¼Œæ„å»ºä¾èµ–å›¾è°±->è½¬åŒ–ASTè¯­æ³•æ ‘->å¤„ç†ä»£ç ->è½¬æ¢ä¸ºæµè§ˆå™¨å¯è¯†åˆ«çš„ä»£ç 

Webpackä¸viteçš„æ‰“åŒ…ç›¸æ¯”ï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼š

webpackæ‰“åŒ…æµç¨‹ï¼šviteï¼šå…ˆbuildâ€”â€”>é€’å½’æ„å»º moduleâ€”â€”â€”â€”â€”â€”ç”Ÿæˆ chunkâ€”â€”â€”â€”â€”â€”â€”â€”chunk ä¼˜åŒ–â€”â€”â€”â€”â€”â€”â€”â€”bubdle(å†…å­˜)â€”â€”>å¯åŠ¨ï¼ˆweb serverï¼‰

ä½†æ˜¯webpack è¿™ç±»å·¥å…·çš„åšæ³•æ˜¯å°†æ‰€æœ‰æ¨¡å—æå‰ç¼–è¯‘ã€æ‰“åŒ…è¿›bundleé‡Œï¼Œæ¢å¥è¯è¯´ï¼Œä¸ç®¡æ¨¡å—æ˜¯å¦ä¼šè¢«æ‰§è¡Œï¼Œéƒ½è¦è¢«ç¼–è¯‘å’Œæ‰“åŒ…åˆ°bundleé‡Œã€‚éšç€é¡¹ç›®è¶Šæ¥è¶Šå¤§ï¼Œæ‰“åŒ…åçš„bundleä¹Ÿè¶Šæ¥è¶Šå¤§ï¼Œæ‰“åŒ…çš„é€Ÿåº¦è‡ªç„¶ä¼šè¶Šæ¥è¶Šæ…¢ã€‚

viteæ‰“åŒ…æµç¨‹ï¼švite--->å¯åŠ¨ web server â€”â€”â€”â€”ç¼–è¯‘è¯·æ±‚çš„æ–‡ä»¶åˆ°æµè§ˆå™¨


1:webpack ä¼šéœ€è¦æ‰“åŒ…ä¸€ä¸ªä¸€ä¸ªå¤§ä½“ç§¯çš„bundle.jsï¼Ÿ ä¹‹å‰ä¼šäº§ç”Ÿæ‰“åŒ…éœ€æ±‚çš„ä¸»è¦åŸå› ï¼š
æµè§ˆå™¨ç¯å¢ƒå¹¶ä¸æ”¯æŒæ¨¡å—åŒ–é›¶æ•£æ¨¡å—æ–‡ä»¶ä¼šäº§ç”Ÿå¤§é‡çš„httpè¯·æ±‚ï¼ˆå¤§é‡è¯·æ±‚åœ¨æµè§ˆå™¨ç«¯ä¼šå‡ºç°å¹¶å‘è¯·æ±‚èµ„æºçš„é—®é¢˜ï¼‰
è€Œviteçš„æ‰“åŒ…åŸç†æ˜¯åŸºäºesæ–°ç‰¹æ€§ Dynamic imports å®ç°çš„ï¼Œé‚£å¯¹è€æµè§ˆå™¨å¿…ç„¶ä¼šæœ‰å…¼å®¹é—®é¢˜ å¤„ç†æ–¹æ¡ˆè¿˜æ˜¯ç”¨å¤§å‰‘ç†Ÿæ‚‰çš„Polyfillã€‚
(npm install dynamic-import-polyfill)
import dynamicImportPolyfill from 'dynamic-import-polyfill';
// This needs to be done before any dynamic imports are used.
dynamicImportPolyfill.initialize({
  modulePath: '/public', // Defaults to '.'
  importFunctionName: '$$import' // Defaults to '__import__'
});

viteæºç åˆ†æ::https://juejin.cn/post/6968793122029436959


vite åœ¨æ„å»ºè¿‡ç¨‹ä¸­ä½¿ç”¨esbuildè¿›è¡Œæ„å»ºï¼Œesbuild æ˜¯ä¸€ä¸ªæ–°çš„ä»£ç æ„å»ºå·¥å…·ï¼Œè¿‘æ¥æ„å»ºé€Ÿåº¦åŠå…¶è¿…çŒ›ï¼Œåœˆç²‰é€Ÿåº¦ä¹Ÿå¾ˆç–¯ç‹‚ï¼Œå®ƒå¯ä»¥å°† CommonJS / UMD è½¬æ¢ä¸º ESM æ ¼å¼,
è½¬æ¢ts, tsxæ–‡ä»¶ç­‰æ–‡ä»¶è½¬åŒ–æˆæµè§ˆå™¨å¯ä»¥è¯†åˆ«çš„jsæ–‡ä»¶,
å®ƒä½¿ç”¨goç¼–å†™,å¹¶ç¼–è¯‘æˆäº†æœºå™¨ç ,åˆ©ç”¨paralleljs çš„é«˜å¹¶è¡Œä¼˜åŠ¿,å…·æœ‰å¤§é‡çš„å¹¶è¡Œç®—æ³•

vite çš„ä½œç”¨å°±æ˜¯ä½“ç°åœ¨äº†è¿™é‡Œ,viteçš„ä»»åŠ¡å°±æ˜¯ç”¨koaèµ·ä¸€ä¸ªhttpè¯·æ±‚,ç„¶ååˆ©ç”¨æ‹¦æˆªå™¨å»æ‹¦æˆªä¿®æ”¹è¿™äº›è¯·æ±‚å†…å®¹

é—®é¢˜ï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼š
ä¸èƒ½è¯†åˆ«mdæ–‡ä»¶ï¼Ÿ
ä¸ºä»€ä¹ˆwebpackå¯ä»¥å¼•å…¥loaderçš„æ–¹å¼åŠ è½½mdæ–‡ä»¶ï¼Ÿ
å¦‚ä½•ç¼–å†™viteæ’ä»¶ï¼Ÿ
viteä¸æ˜¯åŸºäºwebpack ä¸ºä»€ä¹ˆä¸å¯ä»¥å¼•å…¥loader æ€ä¹ˆå†™æ’ä»¶è§£å†³ ï¼Ÿ

gulpæ„å»ºå·¥å…·ï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼š
æ“…é•¿ï¼šå‰ç«¯å¼€å‘æµç¨‹è§„èŒƒç®¡ç†ã€‚ä¸åŒ…æ‹¬æ¨¡å—åŒ–åŠŸèƒ½ã€‚
gulpæ˜¯ä¸€ä¸ªåŸºäºæµçš„æ„å»ºå·¥å…·

gulpæ˜¯åŸºäºNodejs,è‡ªåŠ¨åŒ–åœ°å®Œæˆ javascriptã€coffeeã€sassã€lessã€html/imageã€css ç­‰æ–‡ä»¶çš„æµ‹è¯•ã€æ£€æŸ¥ã€åˆå¹¶ã€å‹ç¼©ã€æ ¼å¼åŒ–ã€æµè§ˆå™¨è‡ªåŠ¨åˆ·æ–°ã€éƒ¨ç½²æ–‡ä»¶ç”Ÿæˆ
å¹¶ç›‘å¬æ–‡ä»¶åœ¨æ”¹åŠ¨åé‡å¤æŒ‡å®šçš„è¿™äº›æ­¥éª¤ã€‚å€Ÿé‰´äº†Unixæ“ä½œç³»ç»Ÿçš„ç®¡é“(pipe)æ€æƒ³,å‰ä¸€çº§çš„è¾“å‡º,ç›´æ¥å˜æˆåä¸€çº§çš„è¾“å…¥,ä½¿å¾—åœ¨æ“ä½œä¸Šéå¸¸ç®€å•ã€‚
æµ,Nodeå°†å‡ ä¹æ‰€æœ‰IOæ“ä½œéƒ½æŠ½è±¡æˆäº†streamçš„æ“ä½œ,ç®€å•æ¥è¯´å°±æ˜¯å»ºç«‹åœ¨é¢å‘å¯¹è±¡åŸºç¡€ä¸Šçš„ä¸€ç§æŠ½è±¡çš„å¤„ç†æ•°æ®çš„å·¥å…·ã€‚
ç‰¹ç‚¹ï¼šå‹ç¼©èµ„æºæ–‡ä»¶,å®é¡µé¢å“åº”é€Ÿåº¦æå‡ã€‚è‡ªåŠ¨æ„å»ºã€‚

webpack--gulpåŒºåˆ«ä¸è”ç³»ï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼š
gulpé…åˆwebpackåˆä½œ
https://juejin.cn/post/6959721156350296095


Lerna æ˜¯ä¸€ä¸ªç®¡ç†å·¥å…·ï¼Œç”¨äºç®¡ç†åŒ…å«å¤šä¸ªè½¯ä»¶åŒ…ï¼ˆpackageï¼‰çš„ JavaScript é¡¹ç›®





vite-plugin-svg-icons
ç”¨äºç”Ÿæˆ svg é›ªç¢§å›¾ï¼Œæ–¹ä¾¿åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ .svg æ–‡ä»¶ã€‚


vite-plugin-mock
æä¾›äº†æœ¬åœ°å’Œç”Ÿäº§ mock æœåŠ¡ã€‚

ä¼˜åŠ¿åœ¨äºæœ¬åœ°ä½¿ç”¨ï¼Œä¸ä¼ ç»Ÿä½¿ç”¨ mockjs ä¸åŒï¼Œæ˜¯å¯ä»¥çœŸå®åœ¨æµè§ˆå™¨é‡Œçœ‹åˆ°è¯·æ±‚è®°å½•ï¼Œå¤§å¤§æé«˜äº†å¼€å‘æ•ˆç‡ã€‚  




ç§»åŠ¨ç«¯æ”¯æŒ
æ¨¡æ¿æ”¯æŒä½¿ç”¨ vw/vh åšä¸ºç§»åŠ¨ç«¯çš„å¸ƒå±€å•ä½ï¼Œå¹¶é»˜è®¤é›†æˆäº† postcss-px-to-viewport æ’ä»¶ã€‚

ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€å°†æ ¹ç›®å½•ä¸‹çš„ .postcss.config.js æ–‡ä»¶ä¿®æ”¹ä¸º postcss.config.js å³å¯ï¼Œæ–‡ä»¶å†…å…·ä½“é…ç½®ä¿¡æ¯å¯æ ¹æ®é¡¹ç›®å®é™…è°ƒæ•´ï¼š

module.exports = {
    plugins: {
        'postcss-px-to-viewport': {
            // éœ€è¦è½¬æ¢çš„å•ä½ï¼Œé»˜è®¤ä¸º px
            unitToConvert: 'px',
            // è§†çª—çš„å®½åº¦ï¼Œå¯¹åº”çš„æ˜¯æˆ‘ä»¬è®¾è®¡ç¨¿çš„å®½åº¦
            viewportWidth: 750,
            // æŒ‡å®š px è½¬æ¢ä¸ºè§†çª—å•ä½å€¼çš„å°æ•°ä½æ•°ï¼ˆå¾ˆå¤šæ—¶å€™æ— æ³•æ•´é™¤ï¼‰
            unitPrecision: 3,
            // èƒ½è½¬åŒ–ä¸º vw çš„å±æ€§åˆ—è¡¨
            propList: ['*'],
            // æŒ‡å®šéœ€è¦è½¬æ¢æˆçš„è§†çª—å•ä½ï¼Œå»ºè®®ä½¿ç”¨ vw
            viewportUnit: 'vw',
            // å­—ä½“ä½¿ç”¨çš„è§†å£å•ä½
            fontViewportUnit: 'vw',
            // æŒ‡å®šä¸è½¬æ¢ä¸ºè§†çª—å•ä½çš„ç±»ï¼Œå¯ä»¥è‡ªå®šä¹‰ï¼Œå¯ä»¥æ— é™æ·»åŠ ,å»ºè®®å®šä¹‰ä¸€è‡³ä¸¤ä¸ªé€šç”¨çš„ç±»å
            selectorBlackList: [
                '.ignore'
            ],
            // å°äºæˆ–ç­‰äº 1px ä¸è½¬æ¢ä¸ºè§†çª—å•ä½ï¼Œä½ ä¹Ÿå¯ä»¥è®¾ç½®ä¸ºä½ æƒ³è¦çš„å€¼
            minPixelValue: 1,
            // å…è®¸åœ¨åª’ä½“æŸ¥è¯¢ä¸­è½¬æ¢ px
            mediaQuery: false
        }
    }
}


viteæ’ä»¶å¤§å…¨ï¼šhttp://www.guofeian.cn/article_details/647258913514991616



viteé…ç½®ï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼šï¼š
/**
 * https://vitejs.dev/config/
 * @type {import('vite').UserConfig}
 */
export default {
  //é¡¹ç›®æ ¹ç›®å½•
  root: process.cwd(),
  //é¡¹ç›®éƒ¨ç½²çš„åŸºç¡€è·¯å¾„
  base: "/",
  //ç¯å¢ƒé…ç½®
  mode: "development",
  //å…¨å±€å˜é‡æ›¿æ¢ Record<string, string>
  define: {
    "": "",
    user: "users",
  },
  //æ’ä»¶
  plugins: [],
  //é™æ€èµ„æºæœåŠ¡çš„æ–‡ä»¶å¤¹
  publicDir: "public",

  resolve: {
    //åˆ«å
    alias: {
      "@": path.resolve(__dirname, "/src"),
      comps: path.resolve(__dirname, "/src/components"),
    },
    dedupe: [],
    //æƒ…æ™¯å¯¼å‡ºpackage.jsoné…ç½®ä¸­çš„exports å­—æ®µ
    conditions: [],
    //è§£æpackage.jsonä¸­çš„å­—æ®µ
    mainFields: ["module", "jsnext:main", "jsnext"],
    //å¯¼å…¥æ—¶æƒ³è¦çœç•¥çš„æ‰©å±•ååˆ—è¡¨
    extensions: [".mjs", ".js", ".ts", ".jsx", ".tsx", ".json"],
  },
  css: {
    //é…ç½® CSS modules çš„è¡Œä¸ºã€‚é€‰é¡¹å°†è¢«ä¼ é€’ç»™ postcss-modulesã€‚
    modules: {},
    // PostCSS é…ç½®ï¼ˆæ ¼å¼åŒ postcss.config.jsï¼‰
    // postcss-load-config çš„æ’ä»¶é…ç½®
    postcss: {},
    //æŒ‡å®šä¼ é€’ç»™ CSS é¢„å¤„ç†å™¨çš„é€‰é¡¹
    preprocessorOptions: {
      scss: {
        additionalData: `$injectedColor: orange;`,
      },
    },
  },
  json: {
    //æ˜¯å¦æ”¯æŒä» .json æ–‡ä»¶ä¸­è¿›è¡ŒæŒ‰åå¯¼å…¥
    namedExports: true,
    //è‹¥è®¾ç½®ä¸º trueï¼Œå¯¼å…¥çš„ JSON ä¼šè¢«è½¬æ¢ä¸º export default JSON.parse("...") ä¼šæ¯”è½¬è¯‘æˆå¯¹è±¡å­—é¢é‡æ€§èƒ½æ›´å¥½ï¼Œ
    //å°¤å…¶æ˜¯å½“ JSON æ–‡ä»¶è¾ƒå¤§çš„æ—¶å€™ã€‚
    //å¼€å¯æ­¤é¡¹ï¼Œåˆ™ä¼šç¦ç”¨æŒ‰åå¯¼å…¥
    stringify: false,
  },
  //ç»§æ‰¿è‡ª esbuild è½¬æ¢é€‰é¡¹ã€‚æœ€å¸¸è§çš„ç”¨ä¾‹æ˜¯è‡ªå®šä¹‰ JSX
  esbuild: {
    jsxFactory: "h",
    jsxFragment: "Fragment",
    jsxInject: `import React from 'react'`,
  },
  //é™æ€èµ„æºå¤„ç†  å­—ç¬¦ä¸²|æ­£åˆ™è¡¨è¾¾å¼
  assetsInclude: "",
  //è°ƒæ•´æ§åˆ¶å°è¾“å‡ºçš„çº§åˆ« 'info' | 'warn' | 'error' | 'silent'
  logLevel: "info",
  //è®¾ä¸º false å¯ä»¥é¿å… Vite æ¸…å±è€Œé”™è¿‡åœ¨ç»ˆç«¯ä¸­æ‰“å°æŸäº›å…³é”®ä¿¡æ¯
  clearScreen: true,
  //æœåŠ¡
  server: {
    //æœåŠ¡å™¨ä¸»æœºå
    host: "",
    //ç«¯å£å·
    port: "",
    //è®¾ä¸º true æ—¶è‹¥ç«¯å£å·²è¢«å ç”¨åˆ™ä¼šç›´æ¥é€€å‡ºï¼Œ
    //è€Œä¸æ˜¯å°è¯•ä¸‹ä¸€ä¸ªå¯ç”¨ç«¯å£
    strictPort: true,
    //https.createServer()é…ç½®é¡¹
    https: "",
    //æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€åº”ç”¨ç¨‹åºã€‚
    //å½“æ­¤å€¼ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œä¼šè¢«ç”¨ä½œ URL çš„è·¯å¾„å
    open: "/docs/index.html",
    //è‡ªå®šä¹‰ä»£ç†è§„åˆ™
    proxy: {
      // å­—ç¬¦ä¸²ç®€å†™å†™æ³•
      "/foo": "http://localhost:4567/foo",
      // é€‰é¡¹å†™æ³•
      "/api": {
        target: "http://jsonplaceholder.typicode.com",
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, ""),
      },
      // æ­£åˆ™è¡¨è¾¾å¼å†™æ³•
      "^/fallback/.*": {
        target: "http://jsonplaceholder.typicode.com",
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/fallback/, ""),
      },
    },
    //å¼€å‘æœåŠ¡å™¨é…ç½® CORS
    //boolean | CorsOptions
    cors: {},
    //è®¾ç½®ä¸º true å¼ºåˆ¶ä½¿ä¾èµ–é¢„æ„å»º
    force: true,
    //ç¦ç”¨æˆ–é…ç½® HMR è¿æ¥
    hmr: {},
    //ä¼ é€’ç»™ chokidar çš„æ–‡ä»¶ç³»ç»Ÿç›‘è§†å™¨é€‰é¡¹
    watch: {},
  },
  //æ„å»º
  build: {
    //æµè§ˆå™¨å…¼å®¹æ€§  "esnext"|"modules"
    target: "modules",
    //è¾“å‡ºè·¯å¾„
    outDir: "dist",
    //ç”Ÿæˆé™æ€èµ„æºçš„å­˜æ”¾è·¯å¾„
    assetsDir: "assets",
    //å°äºæ­¤é˜ˆå€¼çš„å¯¼å…¥æˆ–å¼•ç”¨èµ„æºå°†å†…è”ä¸º base64 ç¼–ç ï¼Œä»¥é¿å…é¢å¤–çš„ http è¯·æ±‚ã€‚è®¾ç½®ä¸º 0 å¯ä»¥å®Œå…¨ç¦ç”¨æ­¤é¡¹
    assetsInlineLimit: 4096,
    //å¯ç”¨/ç¦ç”¨ CSS ä»£ç æ‹†åˆ†
    cssCodeSplit: true,
    //æ„å»ºåæ˜¯å¦ç”Ÿæˆ source map æ–‡ä»¶
    sourcemap: false,
    //è‡ªå®šä¹‰åº•å±‚çš„ Rollup æ‰“åŒ…é…ç½®
    rollupOptions: {},
    //@rollup/plugin-commonjs æ’ä»¶çš„é€‰é¡¹
    commonjsOptions: {},
    //æ„å»ºçš„åº“
    lib: {},
    //å½“è®¾ç½®ä¸º trueï¼Œæ„å»ºåå°†ä¼šç”Ÿæˆ manifest.json æ–‡ä»¶
    manifest: false,
    //è®¾ç½®ä¸º false å¯ä»¥ç¦ç”¨æœ€å°åŒ–æ··æ·†ï¼Œ
    //æˆ–æ˜¯ç”¨æ¥æŒ‡å®šä½¿ç”¨å“ªç§æ··æ·†å™¨
    //boolean | 'terser' | 'esbuild'
    minify: "terser",
    //ä¼ é€’ç»™ Terser çš„æ›´å¤š minify é€‰é¡¹ã€‚
    terserOptions: {},
    //è®¾ç½®ä¸º false æ¥ç¦ç”¨å°†æ„å»ºåçš„æ–‡ä»¶å†™å…¥ç£ç›˜
    write: true,
    //é»˜è®¤æƒ…å†µä¸‹ï¼Œè‹¥ outDir åœ¨ root ç›®å½•ä¸‹ï¼Œåˆ™ Vite ä¼šåœ¨æ„å»ºæ—¶æ¸…ç©ºè¯¥ç›®å½•ã€‚
    emptyOutDir: true,
    //å¯ç”¨/ç¦ç”¨ brotli å‹ç¼©å¤§å°æŠ¥å‘Š
    brotliSize: true,
    //chunk å¤§å°è­¦å‘Šçš„é™åˆ¶
    chunkSizeWarningLimit: 500,
  },
  //ä¾èµ–ä¼˜åŒ–é€‰é¡¹
  optimizeDeps: {
    //æ£€æµ‹éœ€è¦é¢„æ„å»ºçš„ä¾èµ–é¡¹
    entries: [],
    //é¢„æ„å»ºä¸­å¼ºåˆ¶æ’é™¤çš„ä¾èµ–é¡¹
    exclude: [],
    //é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸åœ¨ node_modules ä¸­çš„ï¼Œé“¾æ¥çš„åŒ…ä¸ä¼šè¢«é¢„æ„å»ºã€‚ä½¿ç”¨æ­¤é€‰é¡¹å¯å¼ºåˆ¶é¢„æ„å»ºé“¾æ¥çš„åŒ…ã€‚
    include: [],
  },
  //SSR é€‰é¡¹
  ssr: {
    //åˆ—å‡ºçš„æ˜¯è¦ä¸º SSR å¼ºåˆ¶å¤–éƒ¨åŒ–çš„ä¾èµ–
    external: [],
    //åˆ—å‡ºçš„æ˜¯é˜²æ­¢è¢« SSR å¤–éƒ¨åŒ–ä¾èµ–é¡¹ã€‚
    noExternal: [],
  },
};



































; babel æºç åˆ†æ - å…¥å£
; babel æ˜¯æ—¥å¸¸å·¥ä½œä¸­å¿…ä¸å¯å°‘çš„ä¾èµ–åŒ…ï¼Œè™½ç„¶å¤©å¤©åœ¨ç”¨ï¼Œä½†æ˜¯å¯¹äºå†…éƒ¨æ„é€ å´äº†è§£ä¸å¤šï¼ŒæŠ½ç©ºçœ‹ä¸‹äº†æºç ï¼Œä»å…¥å£æ–‡ä»¶å¼€å§‹ä¸€æ­¥æ­¥è§£å¯† babel æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

; å½“æˆ‘ä»¬ä½¿ç”¨ npm run babel çš„æ—¶å€™ä¼šæ‰§è¡Œåˆ°ä¸‹é¢çš„ä»£ç ï¼Œå…·ä½“ä½ç½®æ˜¯ babel-cli/src/babel/index.jsã€‚

; #!/usr/bin/env node
; import parseArgv from "./options";
; import dirCommand from "./dir";
; import fileCommand from "./file";

; const opts = parseArgv(process.argv);

; if (opts) {
;  // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   const fn = opts.cliOptions.outDir ? dirCommand : fileCommand;
;   fn(opts).catch(err => {
;     console.error(err);
;     process.exitCode = 1;
;   });
; } else {
;   process.exitCode = 2;
; }
; è¿™ä¸ªè¿™é‡Œä¼šä» process ä¸­è·å–é…ç½®ä¿¡æ¯ï¼Œç„¶ååˆ¤æ–­è¾“å…¥çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶è¿˜æ˜¯æ–‡ä»¶å¤¹ï¼Œå‡å¦‚æˆ‘ä»¬çš„æ‰§è¡Œå‘½ä»¤æ˜¯
; babel src --out-dir lib é‚£ä¹ˆè¿™é‡Œçš„å¯¹åº”ç”Ÿæˆçš„ opts å¦‚ä¸‹ï¼š

; {
;   babelOptions: {},
;   cliOptions: {
;     filename: undefined,
;     filenames: [ 'src' ],
;     extensions: undefined,
;     keepFileExtension: undefined,
;     outFileExtension: undefined,
;     watch: true,
;     skipInitialBuild: undefined,
;     outFile: undefined,
;     outDir: 'lib',
;     relative: undefined,
;     copyFiles: undefined,
;     copyIgnored: undefined,
;     includeDotfiles: undefined,
;     verbose: undefined,
;     quiet: undefined,
;     deleteDirOnStart: undefined,
;     sourceMapTarget: undefined
;   }
; }
; å› ä¸ºæˆ‘ä»¬åªä¼ å…¥äº†å…¥å£æ–‡ä»¶ src å’Œå‡ºå£æ–‡ä»¶ lib æ‰€ä»¥å…¶ä»–é…ç½®éƒ½æ˜¯ç©ºçš„ï¼Œè¿™é‡Œçš„ outDir æ˜¯å­˜åœ¨çš„ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œ dirCommand å‘½ä»¤ï¼Œè¿›å…¥ dir.js ä¸­ä¼šæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š

;   if (!cliOptions.skipInitialBuild) {
;     if (cliOptions.deleteDirOnStart) {
;       util.deleteDir(cliOptions.outDir);
;     }

;     fs.mkdirSync(cliOptions.outDir, { recursive: true });

;     startTime = process.hrtime();

;     for (const filename of cliOptions.filenames) {
;       // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œ handle('src') ğŸŒµğŸŒµğŸŒµ
;       compiledFiles += await handle(filename);
;     }

;     if (!cliOptions.quiet) {
;       logSuccess();
;       logSuccess.flush();
;     }
;   }
; ä¹Ÿå°±æ˜¯å¾ªç¯ filenames è¾“å…¥ç„¶åä¼ å…¥åˆ° handle æ‰§è¡Œï¼Œè¿™é‡Œå¯¹åº”å°±æ˜¯æ‰§è¡Œ handle(â€˜srcâ€™)ï¼Œæ¥ç€æ˜¯ handle çš„ä»£ç ï¼š

;   async function handle(filenameOrDir: string): Promise<number> {
;     if (!fs.existsSync(filenameOrDir)) return 0;

;     const stat = fs.statSync(filenameOrDir);

;     if (stat.isDirectory()) {
;       const dirname = filenameOrDir;

;       let count = 0;

;       const files = util.readdir(dirname, cliOptions.includeDotfiles);
;       for (const filename of files) {
;         const src = path.join(dirname, filename);
;         // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;         const written = await handleFile(src, dirname);
;         if (written) count += 1;
;       }

;       return count;
;     } else {
;       const filename = filenameOrDir;
;       const written = await handleFile(filename, path.dirname(filename));

;       return written ? 1 : 0;
;     }
;   }
; è¿™ä¸ªæ–¹æ³•ä¼šè¯»å– src ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œç»„æˆæ•°ç»„ï¼Œç„¶åé€ä¸ªä¼ å…¥åˆ° handleFile ä¸­æ‰§è¡Œ

; // å‡è®¾å…¥å£æ–‡ä»¶çš„ç›®å½•ç»“æ„å¦‚ä¸‹
; // â”œâ”€â”€ src
; // â”‚   â””â”€â”€ index.js

; async function handleFile(src: string, base: string): Promise<boolean> {

;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œ write('src/index.js', 'src') ğŸŒµğŸŒµğŸŒµ
;   const written = await write(src, base);

; if (
;   (cliOptions.copyFiles && written === FILE_TYPE.NON_COMPILABLE) ||
;   (cliOptions.copyIgnored && written === FILE_TYPE.IGNORED)
; ) {
;   const filename = path.relative(base, src);
;   const dest = getDest(filename, base);
;   outputFileSync(dest, fs.readFileSync(src));
;   util.chmod(src, dest);
; }
; return written === FILE_TYPE.COMPILED;
; æ¥ç€æˆ‘ä»¬æŸ¥çœ‹ä¸‹ write æ–¹æ³•ã€‚

;   async function write(
;     src: string,
;     base: string,
;   ): Promise<$Keys<typeof FILE_TYPE>> {
;     let relative = path.relative(base, src);

;     relative = util.withExtension(
;       relative,
;       cliOptions.keepFileExtension
;         ? path.extname(relative)
;         : cliOptions.outFileExtension,
;     );

;     const dest = getDest(relative, base);
;     // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;     const res = await util.compile(src, {
;       ...babelOptions,
;       sourceFileName: slash(path.relative(dest + "/..", src)),
;     });

;     if (!res) return FILE_TYPE.IGNORED;

;     outputFileSync(dest, res.code);
;     util.chmod(src, dest);

;     return FILE_TYPE.COMPILED;
;   }

; å…¶å®å°±æ˜¯ä¼ å…¥äº†è·¯å¾„å’Œé…ç½®ç„¶åæ‰§è¡Œ compile æ–¹æ³•ã€‚

; export function compile(
;   filename: string,
;   opts: Object | Function,
; ): Promise<Object> {
;   opts = {
;     ...opts,
;     caller: CALLER,
;   };

;   return new Promise((resolve, reject) => {
;     // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;     babel.transformFile(filename, opts, (err, result) => {
;       if (err) reject(err);
;       else resolve(result);
;     });
;   });
; }
; ç„¶åå°†æ–‡ä»¶åœ°å€å’Œé…ç½®ä¼ å…¥åˆ° babel.transformFile ä¸­å¤„ç†ã€‚

; è‡³æ­¤ babel-cli çš„å·¥ä½œå°±æ‰§è¡Œå®Œæ¯•ï¼Œæ¥ç€ä¼šè¿›å…¥åˆ° babel-core ä¸­æ‰§è¡Œã€‚

; // babel-core/src/transform-file.ts

; const transformFileRunner = gensync<
;   (filename: string, opts?: InputOptions) => FileResult | null
; >(function* (filename, opts: InputOptions) {
;   const options = { ...opts, filename };

;   const config: ResolvedConfig | null = yield* loadConfig(options);
;   if (config === null) return null;

;   const code = yield* fs.readFile(filename, "utf8");
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   return yield* run(config, code);
; });
; è¿™ä¸ªæ–‡ä»¶ä¸»è¦ä½¿ç”¨ gensync ç”ŸæˆåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ‰§è¡Œæ–¹æ³•ï¼Œæˆ‘ä»¬è¿™é‡Œè°ƒç”¨çš„æ˜¯å¼‚æ­¥æ‰§è¡Œæ–¹å¼ï¼Œæ¥ç€ç»§ç»­å‘ä¸‹æ‰§è¡Œrun æ–¹æ³•ã€‚

; export function* run(
;   config: ResolvedConfig,
;   code: string,
;   ast?: t.File | t.Program | null,
; ): Handler<FileResult> {
;   // ğŸŒµğŸŒµğŸŒµ 1. å°†ä»£ç è½¬åŒ–ä¸º AST ğŸŒµğŸŒµğŸŒµ
;   const file = yield* normalizeFile(
;     config.passes,
;     normalizeOptions(config),
;     code,
;     ast,
;   );

;   const opts = file.opts;
;   try {
;     // ğŸŒµğŸŒµğŸŒµ 2. å°† ES6 çš„ AST è½¬åŒ–ä¸º ES5 çš„ AST ğŸŒµğŸŒµğŸŒµ
;     yield* transformFile(file, config.passes);
;   } catch (e) {}

;   let outputCode, outputMap;
;   try {
;     if (opts.code !== false) {
;       // ğŸŒµğŸŒµğŸŒµ 3. å°† ES5 çš„ AST ç”Ÿæˆ ES5 ä»£ç  ğŸŒµğŸŒµğŸŒµ
;       ({ outputCode, outputMap } = generateCode(config.passes, file));
;     }
;   } catch (e) {}

;   return {
;     metadata: file.metadata,
;     options: opts,
;     ast: opts.ast === true ? file.ast : null,
;     code: outputCode === undefined ? null : outputCode,
;     map: outputMap === undefined ? null : outputMap,
;     sourceType: file.ast.program.sourceType,
;   };
; }

; è¿™ä¸ªæ–¹æ³•ä¸»è¦åšäº†ä¸‰ä»¶äº‹ä»¶ï¼š

; é€šè¿‡ normalizeFile å°†ä¼ å…¥çš„æ–‡ä»¶è½¬åŒ–ä¸º ASTã€‚
; é€šè¿‡ transformFile å¤„ç† AST äº§å‡ºæ–°çš„ ASTã€‚
; é€šè¿‡ generateCode å°†æ–°çš„ AST è½¬åŒ–ä¸ºç›®æ ‡ä»£ç ã€‚
; è‡³æ­¤ï¼Œbabel-core çš„å·¥ä½œå°±ç»“æŸï¼Œè‡³äºä¸‰ä¸ªæ­¥éª¤æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Œåˆ†å¸ƒåœ¨ babel-parserï¼Œbabel-traverseï¼Œ babel-generator ä¸‰ä¸ªåŒ…ä¸­ï¼Œå…·ä½“ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šå…·ä½“ä»‹ç»ã€‚

; babel æºç åˆ†æ ä¸€ parse

; ä¸œéƒ½èŠ±ç¥ 2021-05-09 10:36:10  157  æ”¶è—
; åˆ†ç±»ä¸“æ ï¼š js babel å·¥ç¨‹åŒ–
; ç‰ˆæƒ

; js
; åŒæ—¶è¢« 3 ä¸ªä¸“æ æ”¶å½•
; 32 ç¯‡æ–‡ç« 0 è®¢é˜…
; è®¢é˜…ä¸“æ 

; babel
; 4 ç¯‡æ–‡ç« 0 è®¢é˜…
; è®¢é˜…ä¸“æ 

; å·¥ç¨‹åŒ–
; 4 ç¯‡æ–‡ç« 0 è®¢é˜…
; è®¢é˜…ä¸“æ 
; ä¸Šä¸€ç¯‡ï¼šbabel æºç åˆ†æ ä¸€ å…¥å£

; æ¥ç€ä¸Šç¯‡ï¼Œæˆ‘ä»¬ç»§ç»­åˆ†æ babel å¦‚ä½•å°†åŸå§‹ä»£ç è½¬åŒ–ä¸º AST ã€‚

; ä¸Šç¯‡ä¸­æ‰§è¡Œ normalizeFile å‡½æ•°æ—¶æœ€ç»ˆæ‰§è¡Œçš„æ˜¯ä¸‹é¢çš„ parse æ–¹æ³•ã€‚

; // babel-parser/src/index.js

; export function parse(input: string, options?: Options): File {
;   if (options?.sourceType === "unambiguous") {
;     // some code
;   } else {
;     // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;     return getParser(options, input).parse();
;   }

; æ²¿ç”¨ä¸Šç¯‡ä¸­çš„å‘½ä»¤ï¼Œè¿™é‡Œçš„ options å¯¹åº”å°±æ˜¯

; {
;   sourceType: 'module',
;   sourceFileName: '/Users/9527/Desktop/babel/src/index.js',
;   plugins: [
;     'classProperties',
;     'classPrivateProperties',
;     'classPrivateMethods',
;     'numericSeparator',
;     'logicalAssignment',
;     'nullishCoalescingOperator',
;     'optionalChaining',
;     'jsonStrings',
;     'optionalCatchBinding',
;     'asyncGenerators',
;     'objectRestSpread',
;     'exportNamespaceFrom',
;     'dynamicImport'
;   ]
; }
; æ¥ç€æ‰§è¡Œ getParser æ–¹æ³•

; function getParser(options: ?Options, input: string): Parser {
;   let cls = Parser;
;   if (options?.plugins) {
;     validatePlugins(options.plugins); // æ ¡éªŒæ’ä»¶
;     cls = getParserClass(options.plugins);
;   }
  
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   return new cls(options, input);
; }
; åœ¨ getParserClass æ–¹æ³•ä¸­ï¼Œä¼šå°†æˆ‘ä»¬çš„æ’ä»¶å’Œ parse ä¸­å†…ç½®çš„æ’ä»¶è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å°±è¿”å›ç©ºæ•°ç»„ï¼Œä¸‹é¢æ˜¯ parse å†…ç½®çš„ä¸€äº›æ’ä»¶ï¼š

; const mixinPlugins = {
;   estree,
;   jsx,
;   flow,
;   typescript,
;   v8intrinsic,
;   placeholders
; };
; è¿™é‡Œæ²¡æœ‰åŒ¹é…åˆ°ï¼Œæ‰€ä»¥è¿”å›çš„è¿˜æ˜¯ Parserï¼Œè¿™ä¸ªç±»æ‹¥æœ‰ä¸€æ¡å¾ˆé•¿çš„ç»§æ‰¿é“¾ï¼Œå¦‚ä¸‹

; Parser
; -> StatementParser 
; -> ExpressionParser 
; -> LValParser 
; -> NodeUtils 
; -> UtilParser 
; -> Tokenizer 
; -> ParserError
; -> CommentsParser
; -> BaseParser

; // å¯¹åº”çš„ç›®å½•ç»“æ„
; â”œâ”€â”€ parser
; â”‚   â”œâ”€â”€ base.js
; â”‚   â”œâ”€â”€ comments.js
; â”‚   â”œâ”€â”€ error-codes.js
; â”‚   â”œâ”€â”€ error-message.js
; â”‚   â”œâ”€â”€ error.js
; â”‚   â”œâ”€â”€ expression.js
; â”‚   â”œâ”€â”€ index.js
; â”‚   â”œâ”€â”€ lval.js
; â”‚   â”œâ”€â”€ node.js
; â”‚   â”œâ”€â”€ statement.js
; â”‚   â””â”€â”€ util.js
; æ¯ä¸€ä¸ªç±»éƒ½å•ç‹¬åšäº†ä¸€äº›äº‹æƒ…ï¼Œç„¶åä¼ é€’ç»™ä¸‹ä¸ªç±»ï¼Œå°±åƒæˆ‘ä»¬å¹³å¸¸è¯·å‡éœ€è¦å±‚å±‚å®¡æ‰¹ä¸€æ ·ï¼Œè¿™ç§æ¨¡å¼ä¹Ÿè¢«ç§°ä¸ºè´£ä»»é“¾æ¨¡å¼ã€‚

; ä¸ºäº†æ–¹ä¾¿ç†è§£æ¥ä¸‹æ¥çš„è®²è§£ï¼Œæˆ‘ä»¬å†™ä¸€æ®µæœ€ç®€å•çš„ ES6 ä»£ç ï¼Œçœ‹ä¸‹ parse æ˜¯å¦‚ä½•è§£æçš„ï¼Œå‡å¦‚æˆ‘ä»¬å¾…è§£æçš„ä»£ç ä¸ºï¼š

; let age = 18
; 1
; é‚£ä¹ˆè¿è¡Œå…¥å£æ–‡ä»¶ä¸­æ‰§è¡Œ getParser(options, input).parse() æ—¶ä¼šè¿è¡Œä¸‹é¢ä»£ç ï¼š

; parse(): File {
;   this.enterInitialScopes();
;   const file = this.startNode();
;   const program = this.startNode();
;   this.nextToken();
;   file.errors = null;
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   this.parseTopLevel(file, program);
;   file.errors = this.state.errors;
;   return file;
; }
; ç”Ÿæˆäº† file å’Œ program ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¼ å…¥åˆ° parseTopLevel ä¸­æ‰§è¡Œã€‚

; parseTopLevel(file: N.File, program: N.Program): N.File {
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   file.program = this.parseProgram(program);
;   file.comments = this.state.comments;

;   if (this.options.tokens) file.tokens = this.tokens;

;   return this.finishNode(file, "File");
; }
; é¦–å…ˆæ˜¯å¤„ç† program èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„ body ä¼šå­˜æ”¾æˆ‘ä»¬ä¹¦å†™ä»£ç ç”Ÿæˆçš„èŠ‚ç‚¹ï¼Œä¸è¿‡æ­¤æ—¶è¿˜æœªæŒ‚è½½ body æš‚æ—¶ä¸å­˜åœ¨ï¼ŒèŠ‚ç‚¹ç›®å‰ç»“æ„å¦‚ä¸‹ï¼š

; // program èŠ‚ç‚¹
; Node {
;   type: '',
;   start: 0,
;   end: 0,
;   loc: SourceLocation {
;     start: Position { line: 1, column: 0 },
;     end: undefined,
;     filename: undefined,
;     identifierName: undefined
;   },
;   range: undefined,
;   leadingComments: undefined,
;   trailingComments: undefined,
;   innerComments: undefined,
;   extra: undefined,
;   sourceType: 'module',
;   interpreter: null
; }
; æ¥ç€æ‰§è¡Œ parseProgram æ–¹æ³•ï¼š

; parseProgram(program, end = types.eof, sourceType = this.options.sourceType) {
;   program.sourceType = sourceType;
;   program.interpreter = this.parseInterpreterDirective();
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   this.parseBlockBody(program, true, true, end);

;   if (this.inModule && !this.options.allowUndeclaredExports && this.scope.undefinedExports.size > 0) {
;     for (const [name] of Array.from(this.scope.undefinedExports)) {
;       const pos = this.scope.undefinedExports.get(name);
;       this.raise(pos, ErrorMessages.ModuleExportUndefined, name);
;     }
;   }

;   return this.finishNode(program, "Program");
; }
; å°† program èŠ‚ç‚¹ä¼ å…¥åˆ° parseBlockBody ä¸­å‘ä¸‹æ‰§è¡Œã€‚

; parseBlockBody(node, allowDirectives, topLevel, end, afterBlockParse) {
;   const body = node.body = [];
;   const directives = node.directives = [];
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   this.parseBlockOrModuleBlockBody(body, allowDirectives ? directives : undefined, topLevel, end, afterBlockParse);
; }
; 1
; 2
; 3
; 4
; 5
; 6
; æ­¤æ—¶ä¼šç»™èŠ‚ç‚¹æ·»åŠ  body å±æ€§ï¼Œå› ä¸ºæˆ‘ä»¬ä»£ç ä¸å¯èƒ½åªæœ‰ä¸€è¡Œï¼Œæ‰€æœ‰ä½¿ç”¨æ•°ç»„å­˜æ”¾ï¼Œç„¶åç»§ç»­æ‰§è¡Œ parseBlockOrModuleBlockBody æ–¹æ³•ã€‚

; parseBlockOrModuleBlockBody(body, directives, topLevel, end, afterBlockParse) {
;   const oldStrict = this.state.strict;
;   let hasStrictModeDirective = false;
;   let parsedNonDirective = false;

;   while (!this.match(end)) {
;     // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;     const stmt = this.parseStatement(null, topLevel);

;     if (directives && !parsedNonDirective) {
;       if (this.isValidDirective(stmt)) {
;         const directive = this.stmtToDirective(stmt);
;         directives.push(directive);

;         if (!hasStrictModeDirective && directive.value.value === "use strict") {
;           hasStrictModeDirective = true;
;           this.setStrict(true);
;         }

;         continue;
;       }

;       parsedNonDirective = true;
;       this.state.strictErrors.clear();
;     }

;     body.push(stmt);
;   }

;   if (afterBlockParse) {
;     afterBlockParse.call(this, hasStrictModeDirective);
;   }

;   if (!oldStrict) {
;     this.setStrict(false);
;   }

;   this.next();
; }
; è¿™é‡Œä½¿ç”¨ while æ¥å¾ªç¯åˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰ç»“æŸå°±ç»§ç»­æ‰§è¡Œ parseStatement æ–¹æ³•ã€‚

; parseStatement(context, topLevel) {
;   if (this.match(types.at)) {
;     this.parseDecorators(true);
;   }
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   return this.parseStatementContent(context, topLevel);
; }
; 1
; 2
; 3
; 4
; 5
; 6
; 7
; ä¼ å…¥å‚æ•°ç»™ parseStatementContent æ–¹æ³•ç»§ç»­æ‰§è¡Œï¼š

; parseStatementContent(context, topLevel) {
;   let starttype = this.state.type;
;   const node = this.startNode();
;   let kind;

;   if (this.isLet(context)) {
;     starttype = types._var;
;     kind = "let";
;   }

;   switch (starttype) {
;     case types._break:
;     case types._continue:
;       return this.parseBreakContinueStatement(node, starttype.keyword);
;     case types._function:
;       if (this.lookaheadCharCode() === 46) break;

;       if (context) {
;         if (this.state.strict) {
;           this.raise(this.state.start, ErrorMessages.StrictFunction);
;         } else if (context !== "if" && context !== "label") {
;           this.raise(this.state.start, ErrorMessages.SloppyFunction);
;         }
;       }

;       return this.parseFunctionStatement(node, false, !context);

;     case types._const:
;     case types._var:
;       kind = kind || this.state.value;

;       if (context && kind !== "var") {
;         this.raise(this.state.start, ErrorMessages.UnexpectedLexicalDeclaration);
;       }
;       // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;       return this.parseVarStatement(node, kind);

;       // ... code ...
;     default:
;       {
;         if (this.isAsyncFunction()) {
;           if (context) {
;             this.raise(this.state.start, ErrorMessages.AsyncFunctionInSingleStatementContext);
;           }

;           this.next();
;           return this.parseFunctionStatement(node, true, !context);
;         }
;       }
;   }

;   const maybeName = this.state.value;
;   const expr = this.parseExpression();

;   if (starttype === types.name && expr.type === "Identifier" && this.eat(types.colon)) {
;     return this.parseLabeledStatement(node, maybeName, expr, context);
;   } else {
;     return this.parseExpressionStatement(node, expr);
;   }
; }

; è¿™é‡Œé€šè¿‡é¦–å…ˆé€šè¿‡ this.startNode() ç”Ÿæˆäº†æ–°çš„èŠ‚ç‚¹ï¼Œç„¶åé€šè¿‡ this.isLet(context) åˆ¤æ–­æ˜¯å¦ let å£°æ˜ï¼Œæˆ‘ä»¬ä¹‹å‰å‡è®¾å¾…ä»£ç æ˜¯ let age = 18 , æ‰€ä»¥ä¼šåŒ¹é…åˆ° types._varï¼Œç„¶åæ‰§è¡Œ parseVarStatement æ–¹æ³•ã€‚

;   parseVarStatement(node, kind) {
;     this.next();
;     this.parseVar(node, false, kind);
;     this.semicolon();
;     return this.finishNode(node, "VariableDeclaration");
;   }

; è¿™ä¸ªæ–¹æ³•ä¼šè§£æå˜é‡ï¼Œæ·»åŠ æœ«å°¾åˆ†å·ç­‰æ“ä½œï¼Œæœ€åè°ƒç”¨ finishNode æ‰§è¡Œåä¼šè¿”å›ä¸€ä¸ªå˜é‡å£°æ˜èŠ‚ç‚¹ï¼Œç»“æ„å¦‚ä¸‹ï¼š

; {
;     "type":"VariableDeclaration",
;     "start":0,
;     "end":18,
;     "loc":{
;         "start":{
;             "line":1,
;             "column":0
;         },
;         "end":{
;             "line":1,
;             "column":18
;         }
;     },
;     "declarations":[
;         {
;             "type":"VariableDeclarator",
;             "start":4,
;             "end":17,
;             "loc":{
;                 "start":{
;                     "line":1,
;                     "column":4
;                 },
;                 "end":{
;                     "line":1,
;                     "column":17
;                 }
;             },
;             "id":{
;                 "type":"Identifier",
;                 "start":4,
;                 "end":8,
;                 "loc":{
;                     "start":{
;                         "line":1,
;                         "column":4
;                     },
;                     "end":{
;                         "line":1,
;                         "column":8
;                     },
;                     "identifierName":"name"
;                 },
;                 "name":"name"
;             },
;             "init":{
;                 "type":"NumericLiteral",
;                 "start":11,
;                 "end":17,
;                 "loc":{
;                     "start":{
;                         "line":1,
;                         "column":11
;                     },
;                     "end":{
;                         "line":1,
;                         "column":17
;                     }
;                 },
;                 "extra":{
;                     "rawValue":123123,
;                     "raw":"123123"
;                 },
;                 "value":123123
;             }
;         }
;     ],
;     "kind":"let"
; }

; ä¹‹åå°±æ˜¯ä¸€è·¯ returnï¼Œç„¶ååœ¨ parseBlockOrModuleBlockBody ä¸­å°†è¿”å›çš„èŠ‚ç‚¹æ·»åŠ åˆ° body ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬åªæœ‰ä¸€è¡Œä»£ç ï¼Œæ‰€ä»¥ç»§ç»­æ‰§è¡Œ this.next() æ—¶ä¹Ÿä¼š return å‡ºæ ˆã€‚

; è‡³æ­¤ parse è§£æå®Œæˆã€‚

; babelæºç åˆ†æ - traverse

; ä¸œéƒ½èŠ±ç¥ 2021-05-09 22:25:13  181  æ”¶è—
; åˆ†ç±»ä¸“æ ï¼š babel å·¥ç¨‹åŒ– js
; ç‰ˆæƒ

; babel
; åŒæ—¶è¢« 3 ä¸ªä¸“æ æ”¶å½•
; 4 ç¯‡æ–‡ç« 0 è®¢é˜…
; è®¢é˜…ä¸“æ 

; å·¥ç¨‹åŒ–
; 4 ç¯‡æ–‡ç« 0 è®¢é˜…
; è®¢é˜…ä¸“æ 

; js
; 32 ç¯‡æ–‡ç« 0 è®¢é˜…
; è®¢é˜…ä¸“æ 
; ä¸Šä¸€ç¯‡ï¼šbabel æºç åˆ†æ ä¸€ parse

; æ¥ç€ä¸Šç¯‡ï¼Œtraverse çš„ä¸»è¦å·¥ä½œæ˜¯å°† ES6 çš„ AST è½¬åŒ–ä¸º ES5 çš„ ASTï¼Œbabel çš„å„ç§æ’ä»¶ä¹Ÿéƒ½æ˜¯åŸºäºæ­¤å®ç°çš„ï¼Œæ¯”å¦‚ JSXï¼ŒTS çš„è½¬åŒ–ç­‰ã€‚

; è¿˜è®°å¾—å…¥å£ç¯‡ä¸­æœ€å run æ–¹æ³•é‡Œçš„ transformFile æ–¹æ³•å—ï¼Œå®ƒæ‰§è¡Œçš„æ—¶å€™æœ€ç»ˆä¼šæ‰§è¡Œä¸‹é¢çš„æ–¹æ³•ï¼š

; // babel-traverse/src/index.js

; function traverse(
;   parent: t.Node,
;   opts: TraverseOptions = {},
;   scope?: Scope,
;   state?: any,
;   parentPath?: NodePath,
; ) {
;   if (!parent) return;

;   if (!t.VISITOR_KEYS[parent.type]) {
;     return;
;   }

;   visitors.explode(opts);
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   traverse.node(parent, opts, scope, state, parentPath);
; }

; è¿™é‡Œçš„ parent å°±æ˜¯ä¹‹å‰ç”Ÿæˆçš„ ASTï¼Œopts æ˜¯æ ¹æ® babel.config.js çš„é…ç½®æ‰€éœ€è¦ä¾èµ–æ’ä»¶ç”Ÿæˆçš„æ•°ç»„ï¼Œå…¶ä¸­å°±åŒ…å«äº†å¤„ç† let å˜é‡çš„ VariableDeclarationï¼Œä¹‹åæ‰§è¡Œ node æ–¹æ³•ã€‚

; traverse.node = function (
;   node: t.Node,
;   opts: TraverseOptions,
;   scope?: Scope,
;   state?: any,
;   parentPath?: NodePath,
;   skipKeys?,
; ) {
;   const keys = t.VISITOR_KEYS[node.type];
;   if (!keys) return;
  
;   const context = new TraversalContext(scope, opts, state, parentPath);
;   for (const key of keys) {
;     if (skipKeys && skipKeys[key]) continue;
;     // ğŸŒµğŸŒµğŸŒµ context.visit(ast, 'program') ğŸŒµğŸŒµğŸŒµ
;     if (context.visit(node, key)) return;
;   }
; };

; å…¶ä¸­çš„ VISITOR_KEYS æ˜¯å®šä¹‰åœ¨ babel-types ä¸­ï¼Œå®šä¹‰äº†æ¯ç§èŠ‚ç‚¹å¯¹åº”çš„ keyï¼Œé¦–æ¬¡è¿›æ¥çš„æ—¶å€™èŠ‚ç‚¹çš„ç±»å‹æ˜¯ fileï¼Œæ ¹æ®ä¸‹é¢çš„é…ç½®å¯¹åº”è·å–çš„ key å°±æ˜¯ programã€‚

; // babel-types/src/definitions/core.ts

; defineType("File", {
;   builder: ["program", "comments", "tokens"],
;   visitor: ["program"],
;   fields: {
;     program: {
;       validate: assertNodeType("Program"),
;     },
;     comments: {
;       validate: !process.env.BABEL_TYPES_8_BREAKING
;         ? Object.assign(() => {}, {
;             each: { oneOfNodeTypes: ["CommentBlock", "CommentLine"] },
;           })
;         : assertEach(assertNodeType("CommentBlock", "CommentLine")),
;       optional: true,
;     },
;     tokens: {
;       // todo(ts): add Token type
;       validate: assertEach(Object.assign(() => {}, { type: "any" })),
;       optional: true,
;     },
;   },
; });

; æ¥ç€å°† AST å’Œ program ä¾æ¬¡ä¼ å…¥åˆ° visit -> visitSingle -> visitQueue ä¸­æ‰§è¡Œ

; visit(node, key) {
;   const nodes = node[key];
;   if (!nodes) return false;

;   if (Array.isArray(nodes)) {
;     return this.visitMultiple(nodes, node, key);
;   } else {
;     // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;     return this.visitSingle(node, key);
;   }
; }

; // -------------æˆ‘å¿«ä¹çš„åˆ†å‰²çº¿--------------

; visitSingle(node, key): boolean {
;   if (this.shouldVisit(node[key])) {
;     // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;     return this.visitQueue([this.create(node, node, key)]);
;   } else {
;     return false;
;   }
; }

; // -------------æˆ‘æ˜¯å¿«ä¹çš„åˆ†å‰²çº¿--------------

; visitQueue(queue: Array<NodePath>) {
;   this.queue = queue;
;   this.priorityQueue = [];

;   const visited = new WeakSet();
;   let stop = false;

;   for (const path of queue) {
;     path.resync();

;     if (
;       path.contexts.length === 0 ||
;       path.contexts[path.contexts.length - 1] !== this
;     ) {
;       path.pushContext(this);
;     }

;     if (path.key === null) continue;

;     if (testing && queue.length >= 10_000) {
;       this.trap = true;
;     }

;     const { node } = path;
;     if (visited.has(node)) continue;
;     if (node) visited.add(node);
;     // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;     if (path.visit()) {
;       stop = true;
;       break;
;     }

;     if (this.priorityQueue.length) {
;       stop = this.visitQueue(this.priorityQueue);
;       this.priorityQueue = [];
;       this.queue = queue;
;       if (stop) break;
;     }
;   }

;   for (const path of queue) {
;     path.popContext();
;   }

;   this.queue = null;

;   return stop;
; }
; ç„¶åå°±æ˜¯æ‰§è¡Œ visit æ–¹æ³•ã€‚

; export function visit(this: NodePath): boolean {
;   if (!this.node) {
;     return false;
;   }

;   if (this.isDenylisted()) {
;     return false;
;   }

;   if (this.opts.shouldSkip && this.opts.shouldSkip(this)) {
;     return false;
;   }

;   // Note: We need to check "this.shouldSkip" twice because
;   // the visitor can set it to true. Usually .shouldSkip is false
;   // before calling the enter visitor, but it can be true in case of
;   // a requeued node (e.g. by .replaceWith()) that is then marked
;   // with .skip().
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   if (this.shouldSkip || this.call("enter") || this.shouldSkip) {
;     this.debug("Skip...");
;     return this.shouldStop;
;   }

;   this.debug("Recursing into...");
;   traverse.node(
;     this.node,
;     this.opts,
;     this.scope,
;     this.state,
;     this,
;     this.skipKeys,
;   );
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   this.call("exit");

;   return this.shouldStop;
; }
; è¿™ä¸ªæ–¹æ³•ä¼šæ‰§è¡Œæ’ä»¶ä¸­æŒ‚è½½çš„ enter å’Œ exit æ–¹æ³•æ–¹æ³•ï¼Œè€Œ enter å’Œ exit æ–¹æ³•çš„æ”¶é›†æ˜¯åœ¨ transformFile ä¸­ï¼Œä¹Ÿæ˜¯åœ¨è½¬åŒ–é€»è¾‘ä¹‹å‰ä¹‹å‰æ”¶é›†çš„ã€‚

; function* transformFile(file: File, pluginPasses: PluginPasses): Handler<void> {
;   for (const pluginPairs of pluginPasses) {
;     const passPairs = [];
;     const passes = [];
;     const visitors = [];

;     for (const plugin of pluginPairs.concat([loadBlockHoistPlugin()])) {
;       const pass = new PluginPass(file, plugin.key, plugin.options);

;       passPairs.push([plugin, pass]);
;       passes.push(pass);
;       visitors.push(plugin.visitor);
;     }

;     // ğŸŒµğŸŒµğŸŒµ merge all plugin visitors into a single visitor ğŸŒµğŸŒµğŸŒµ
;     const visitor = traverse.visitors.merge(
;       visitors,
;       passes,
;       file.opts.wrapPluginVisitorMethod,
;     );
;     // ğŸŒµğŸŒµğŸŒµ è½¬åŒ–å…¥å£ ğŸŒµğŸŒµğŸŒµ
;     traverse(file.ast, visitor, file.scope);
;   }
; }
; ç„¶åå°±è¿›å…¥åˆ°å¯¹åº”çš„æ’ä»¶ä¸­æ‰§è¡Œï¼Œæˆ‘ä»¬è¿™éœ€è¦å°† let è½¬åŒ–ä¸º varï¼Œæ‰€ä»¥å°±ä¼šè¿›å…¥åˆ° plugin-transform-block-scoping ä¸­æ‰§è¡Œå…·ä½“æ‰§è¡Œè¿‡ç¨‹å°±ä¸è´´éƒ½æ˜¯æµæ°´è´¦ï¼Œå¤§è‡´é¡ºåºå¦‚ä¸‹ï¼š

; "BlockStatement|SwitchStatement|Program"(path, state)
; -> blockScoping.run();
; -> this.getLetReferences();
; -> addDeclarationsFromChild(declarPaths[i]);
; -> convertBlockScopedToVar(path, node, block, this.scope);
; å…¶ä¸­å°† let è½¬åŒ–ä¸º var çš„æ“ä½œå°±åœ¨æœ€åä¸€ä¸ªå‡½æ•°ä¸­

; function convertBlockScopedToVar(
;   path,
;   node,
;   parent,
;   scope,
;   moveBindingsToParent = false,
; ) {
;   if (!node) {
;     node = path.node;
;   }

;   // https://github.com/babel/babel/issues/255
;   if (isInLoop(path) && !t.isFor(parent)) {
;     for (let i = 0; i < node.declarations.length; i++) {
;       const declar = node.declarations[i];
;       declar.init = declar.init || scope.buildUndefinedNode();
;     }
;   }
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   node[t.BLOCK_SCOPED_SYMBOL] = true;
;   node.kind = "var";

;   // Move bindings from current block scope to function scope.
;   if (moveBindingsToParent) {
;     const parentScope = scope.getFunctionParent() || scope.getProgramParent();
;     for (const name of Object.keys(path.getBindingIdentifiers())) {
;       const binding = scope.getOwnBinding(name);
;       if (binding) binding.kind = "var";
;       scope.moveBindingTo(name, parentScope);
;     }
;   }
; }
; è¿™æ–¹æ³•ä¼šå°† AST ä¸Šçš„å˜é‡èŠ‚ç‚¹çš„ kind å±æ€§ä» let å˜æˆ varã€‚

; è‡³æ­¤ï¼Œtraverse é€»è¾‘å°±åˆ†æå®Œæ¯•ï¼Œæ¥ä¸‹å°±æ˜¯æ ¹æ®è½¬åŒ–å¥½çš„ AST ç”Ÿæˆ ES5 ä»£ç äº†ã€‚
; babelæºç åˆ†æ - generator

; ä¸œéƒ½èŠ±ç¥ 2021-05-30 10:05:03  64  æ”¶è—
; åˆ†ç±»ä¸“æ ï¼š babel js å·¥ç¨‹åŒ–
; ç‰ˆæƒ

; babel
; åŒæ—¶è¢« 3 ä¸ªä¸“æ æ”¶å½•
; 4 ç¯‡æ–‡ç« 0 è®¢é˜…
; è®¢é˜…ä¸“æ 

; js
; 32 ç¯‡æ–‡ç« 0 è®¢é˜…
; è®¢é˜…ä¸“æ 

; å·¥ç¨‹åŒ–
; 4 ç¯‡æ–‡ç« 0 è®¢é˜…
; è®¢é˜…ä¸“æ 
; ä¸Šä¸€ç¯‡ï¼šbabelæºç åˆ†æ - traverse

; è¿™æ˜¯ babel è§£æçš„æœ€åä¸€ç¯‡ï¼ŒåšæŒå°±æ˜¯èƒœåˆ©âœŒï¸ã€‚

; åœ¨è¿™ç¯‡ä¸­æˆ‘ä¼šæ¢³ç†ä¸‹ babel æ˜¯å¦‚ä½•éœ€è¦å€ŸåŠ© generator æ–¹æ³•å°†å¤„ç†å¥½çš„ AST é‡æ–°è½¬åŒ–ä¸ºä»£ç ï¼Œä»è€Œå®Œæˆæ•´ä¸ªæµç¨‹ã€‚

; é¦–å…ˆè¿˜æ˜¯å›åˆ° babel-core çš„ run æ–¹æ³•ä¸­ï¼Œå½“æ‰§è¡Œ generateCode(config.passes, file) æ–¹æ³•æ—¶æœ€ç»ˆæ‰§è¡Œçš„ä¸‹é¢çš„ä»£ç :

; // babel-generator/src/index.ts

; export default function generate(
;   ast: t.Node,
;   opts?: GeneratorOptions,
;   code?: string | { [filename: string]: string },
; ): any {
;   const gen = new Generator(ast, opts, code);
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   return gen.generate();
; }
; å½“è°ƒç”¨ generate æ—¶æ‰§è¡Œçš„æ˜¯ Printer ä¸­çš„ generateã€‚

; // Generator
; generate() {
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   return super.generate(this.ast);
; }

; // -------------æˆ‘æ˜¯å¿«ä¹çš„åˆ†å‰²çº¿--------------

; // Printer
; generate(ast) {
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   this.print(ast);
;   this._maybeAddAuxComment();

;   return this._buf.get();
; }
; ç„¶åå°† ast ä¼ å…¥åˆ°å®ä¾‹ä¸Š print æ–¹æ³•ä¸­å¼€å§‹ç”Ÿæˆé€»è¾‘ã€‚

; print(node, parent ?) {
;   if (!node) return;

;   const oldConcise = this.format.concise;
;   if (node._compact) {
;     this.format.concise = true;
;   }

;   const printMethod = this[node.type];
;   if (!printMethod) { }

;   this._printStack.push(node);

;   const oldInAux = this._insideAux;
;   this._insideAux = !node.loc;
;   this._maybeAddAuxComment(this._insideAux && !oldInAux);

;   let needsParens = n.needsParens(node, parent, this._printStack);
;   if (
;     this.format.retainFunctionParens &&
;     node.type === "FunctionExpression" &&
;     node.extra &&
;     node.extra.parenthesized
;   ) {
;     needsParens = true;
;   }
;   if (needsParens) this.token("(");

;   this._printLeadingComments(node);

;   const loc = t.isProgram(node) || t.isFile(node) ? null : node.loc;
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   this.withSource("start", loc, () => {
;     printMethod.call(this, node, parent);
;   });

;   this._printTrailingComments(node);

;   if (needsParens) this.token(")");

;   // end
;   this._printStack.pop();

;   this.format.concise = oldConcise;
;   this._insideAux = oldInAux;
; }
; è¿™é‡Œçš„ withSource ä¼šå¤šæ¬¡æ‰§è¡Œï¼Œåˆ†åˆ«å¯¹åº”ç€ Fileï¼ŒProgramï¼ŒVariableDeclaration

; // babel-generator/src/generators/base.ts

; export function File(this: Printer, node: t.File) {
;   if (node.program) {
;     // Print this here to ensure that Program node 'leadingComments' still
;     // get printed after the hashbang.
;     this.print(node.program.interpreter, node);
;   }

;   this.print(node.program, node);
; }

; // -------------æˆ‘æ˜¯å¿«ä¹çš„åˆ†å‰²çº¿--------------

; export function Program(this: Printer, node: t.Program) {
;   this.printInnerComments(node, false);
  
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   this.printSequence(node.directives, node);
;   if (node.directives && node.directives.length) this.newline();

;   this.printSequence(node.body, node);
; }
; å½“æ‰§è¡Œ printSequence çš„æ—¶å€™ä¼šè·³åˆ° printer ä¸­ç»§ç»­æ‰§è¡Œ

; // packages/babel-generator/src/printer.ts

; printSequence(
;   nodes,
;   parent,
;   opts: {
;   statement?: boolean;
;   indent?: boolean;
;   addNewlines?: Function;
;   } = {},
;   ) {
;     opts.statement = true;
;     // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;     return this.printJoin(nodes, parent, opts);
;   }

; // -------------æˆ‘æ˜¯å¿«ä¹çš„åˆ†å‰²çº¿--------------

; printJoin(nodes: Array<any> | undefined | null, parent: any, opts: any = {}) {
;   if (!nodes?.length) return;

;       if (opts.indent) this.indent();

;   const newlineOpts = {
;     addNewlines: opts.addNewlines,
;   };

;   for (let i = 0; i < nodes.length; i++) {
;     const node = nodes[i];
;     if (!node) continue;

;     if (opts.statement) this._printNewline(true, node, parent, newlineOpts);
;     // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;     this.print(node, parent);

;     if (opts.iterator) {
;       opts.iterator(node, i);
;     }

;     if (opts.separator && i < nodes.length - 1) {
;       opts.separator.call(this);
;     }

;     if (opts.statement) this._printNewline(false, node, parent, newlineOpts);
;   }

;   if (opts.indent) this.dedent();
; }

; // -------------æˆ‘æ˜¯å¿«ä¹çš„åˆ†å‰²çº¿--------------

;  print(node, parent?) {
;   if (!node) return;

;   const oldConcise = this.format.concise;
;   if (node._compact) {
;     this.format.concise = true;
;   }

;   const printMethod = this[node.type];
;   if (!printMethod) {}

;   this._printStack.push(node);

;   const oldInAux = this._insideAux;
;   this._insideAux = !node.loc;
;   this._maybeAddAuxComment(this._insideAux && !oldInAux);

;   let needsParens = n.needsParens(node, parent, this._printStack);
;   if (
;     this.format.retainFunctionParens &&
;     node.type === "FunctionExpression" &&
;     node.extra &&
;     node.extra.parenthesized
;   ) {
;     needsParens = true;
;   }
;   if (needsParens) this.token("(");

;   this._printLeadingComments(node);

;   const loc = t.isProgram(node) || t.isFile(node) ? null : node.loc;
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   this.withSource("start", loc, () => {
;     printMethod.call(this, node, parent);
;   });

;   this._printTrailingComments(node);

;   if (needsParens) this.token(")");

;   // end
;   this._printStack.pop();

;   this.format.concise = oldConcise;
;   this._insideAux = oldInAux;
; }

; // -------------æˆ‘æ˜¯å¿«ä¹çš„åˆ†å‰²çº¿--------------

; withSource(prop: string, loc: any, cb: () => void): void {
;   this._catchUp(prop, loc);
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   this._buf.withSource(prop, loc, cb);
; }
; ä¹‹åä¼šè·³åˆ° buffer.ts æ‰§è¡Œ withSource æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œå‚æ•°ä¸­çš„ cb æ–¹æ³•

; // babel-generator/src/buffer.ts

; withSource(prop: string, loc: t.SourceLocation, cb: () => void): void {
;   // ğŸŒµğŸŒµğŸŒµ æ‰§è¡Œè¿™é‡Œ ğŸŒµğŸŒµğŸŒµ
;   if (!this._map) return cb();

;   // Use the call stack to manage a stack of "source location" data because
;   // the _sourcePosition object is mutated over the course of code generation,
;   // and constantly copying it would be slower.
;   const originalLine = this._sourcePosition.line;
;   const originalColumn = this._sourcePosition.column;
;   const originalFilename = this._sourcePosition.filename;
;   const originalIdentifierName = this._sourcePosition.identifierName;

;   this.source(prop, loc);

;   cb();

;   if (
;     // If the current active position is forced, we only want to reactivate
;     // the old position if it is different from the newest position.
;     (!this._sourcePosition.force ||
;       this._sourcePosition.line !== originalLine ||
;       this._sourcePosition.column !== originalColumn ||
;       this._sourcePosition.filename !== originalFilename) &&
;     // Verify if reactivating this specific position has been disallowed.
;     (!this._disallowedPop ||
;       this._disallowedPop.line !== originalLine ||
;       this._disallowedPop.column !== originalColumn ||
;       this._disallowedPop.filename !== originalFilename)
;   ) {
;     this._sourcePosition.line = originalLine;
;     this._sourcePosition.column = originalColumn;
;     this._sourcePosition.filename = originalFilename;
;     this._sourcePosition.identifierName = originalIdentifierName;
;     this._sourcePosition.force = false;
;     this._disallowedPop = null;
;   }

; å…¶å®å°±æ˜¯ä¸Šé¢ print æ–¹æ³•ä¸­çš„ printMethod.call(this, node, parent); è¿™æ®µä»£ç ï¼Œå…¶ä¸­ printMethod å¦‚ä¸‹ï¼š

; const printMethod = this[node.type];

; // -------------æˆ‘æ˜¯å¿«ä¹çš„åˆ†å‰²çº¿--------------

; // Expose the node type functions and helpers on the prototype for easy usage.
; Object.assign(Printer.prototype, generatorFunctions);

; æ­¤æ—¶ node æ˜¯ä¸€ä¸ªå˜é‡èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ­¤æ—¶ type å°±æ˜¯ VariableDeclarationï¼Œè¿™é‡Œçš„ this æ˜¯ä¸€ä¸ª Printer å®ä¾‹ï¼Œå®ƒæœ¬èº«å¹¶æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œè€Œæ˜¯é€šè¿‡åŸå‹è·å–çš„ generatorFunctions ä¸­çš„æ–¹æ³•ï¼Œå¦‚ä¸‹

; // babel-generator/src/generators/statements.ts

; export function VariableDeclaration(
;   this: Printer,
;   node: t.VariableDeclaration,
;   parent: t.Node,
; ) {
;   if (node.declare) {
;     this.word("declare");
;     this.space();
;   }

;   this.word(node.kind);
;   this.space();

;   let hasInits = false;
;   // don't add whitespace to loop heads
;   if (!t.isFor(parent)) {
;     for (const declar of node.declarations as Array<any>) {
;       if (declar.init) {
;         // has an init so let's split it up over multiple lines
;         hasInits = true;
;       }
;     }
;   }

;   let separator;
;   if (hasInits) {
;     separator =
;       node.kind === "const"
;         ? constDeclarationIndent
;         : variableDeclarationIndent;
;   }

;   this.printList(node.declarations, node, { separator });

;   if (t.isFor(parent)) {
;     // don't give semicolons to these nodes since they'll be inserted in the parent generator
;     if (t.isForStatement(parent)) {
;       if (parent.init === node) return;
;     } else {
;       if (parent.left === node) return;
;     }
;   }

;   this.semicolon();
; }

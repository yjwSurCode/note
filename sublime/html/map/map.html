<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>è‡ªå®šä¹‰æ …æ ¼å›¾å±‚</title>
  </head>
  <script
    charset="utf-8"
    src="https://map.qq.com/api/gljs?v=1.exp&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77"
  ></script>
  <script
    type="text/javascript"
    src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"
  ></script>
  <style type="text/css">
    html,
    body {
      height: 100%;
      margin: 0px;
      padding: 0px;
    }

    #mapContainer {
      width: 100%;
      height: 100%;
    }
  </style>

  <body>
    <div id="mapContainer"></div>
    <div
      style="
        display: flex;
        justify-content: space-around;
        width: 100%;
        position: absolute;
        top: 20px;
        z-index: 99999;
      "
    >
      <div
        id="playId"
        style="
          background-color: rgb(255, 255, 255);
          border-radius: 10px;
          width: 40px;
          height: 20px;
          text-align: center;
          line-height: 20px;
          font-size: 10px;
          color: rgb(0, 255, 255);
        "
      >
        æ¸¸
      </div>
      <div
        style="
          background-color: rgb(255, 255, 255);
          border-radius: 10px;
          width: 40px;
          height: 20px;
          text-align: center;
          line-height: 20px;
          font-size: 10px;
          color: rgb(0, 255, 255);
        "
      >
        ç©
      </div>
    </div>
    <p id="markerId">markerID:</p>
    <p id="position">å½“å‰markerä½ç½®:</p>

    <div class="markerContet">
      <div>ä»‹ç»</div>
      <div>å¯¼èˆª</div>
      <div>å…¨æ™¯</div>
      <div>è¯­éŸ³</div>
    </div>
    <script>
      function play() {
        console.log('123');
        wx.miniProgram.postMessage({
          // å‘å°ç¨‹åºå‘é€æ¶ˆæ¯
          data: {
            title: 'play',
            // path: `${
            //   MINI_PROGRAME_URL_MAP['good']
            // }?src=${getUrlPrefix()}/good/${goodDetail.id}`,
            path: `/pages/web-view/index`,
            // imageUrl: goodDetail?.good_img,
          },
        });
      }

      document.getElementById('playId').addEventListener('click', play, false);

      const initPage = () => {
        const weChatUrl = window.location.href;
        console.log(weChatUrl, 'weChatUrl');

        let urlStr = weChatUrl.split('?')[1];
        if (!urlStr) return;
        console.log(urlStr, 'urlStr', encodeURIComponent(urlStr));
        const urlSearchParams = new URLSearchParams(urlStr);
        console.log(urlSearchParams, 'urlSearchParams');
        const result = Object.fromEntries(urlSearchParams.entries());
        console.log(result.list, 'result1');
        const markerList = JSON.parse(result.list); //const params = [ { position: [30, 114], content: "Marker 1" },
        console.log('ğŸš€ ~ markerList:', markerList.length);
        //   if (!markerList && markerList.length == 0) return;

        // const geometriesList = markerList.map((item, index) => {
        //   return {
        //     id: 'demo',
        //     styleId: 'marker',
        //     position: new TMap.LatLng(item.position[0], item.position[1]),
        //     properties: {
        //       title: item.content,
        //     },
        //   };
        // });

        const geometriesList = [
          {
            id: 'demo1',
            styleId: 'marker',
            position: new TMap.LatLng(26.870355, 100.239704),
            content: 'é‚£å®¶å±±åŸ',
            properties: {
              title: 'marker',
            },
          },
          {
            id: 'demo2',
            styleId: 'marker',
            position: new TMap.LatLng(26.875355, 100.239704),
            content: 'æˆ‘ä¹å®¶å…·',
            properties: {
              title: 'marker',
            },
          },
        ];
        console.log(geometriesList, 'geometriesList');

        //åˆå§‹åŒ–åœ°å›¾
        var map = new TMap.Map('mapContainer', {
          zoom: 15,
          maxZoom: 16,
          center: new TMap.LatLng(26.870355, 100.239704), // è®¾ç½®åœ°å›¾ä¸­å¿ƒç‚¹åæ ‡ï¼Œ
          pitch: 0, // ä¿¯ä»°åº¦
          rotation: 0, // æ—‹è½¬è§’åº¦
        });
        // ç“¦ç‰‡å‘½åè§„èŒƒä¸ºï¼šz(åœ°å›¾çº§åˆ«)/x(åˆ—å·)_y(è¡Œå·).pngï¼ˆä»¥pngæ ¼å¼ä¸¾ä¾‹ï¼‰
        //åˆå§‹åŒ–imageTileLayer
        var imageTileLayer = new TMap.ImageTileLayer({
          getTileUrl: function (x, y, z) {
            //æ‹¼æ¥ç“¦ç‰‡URL
            var url =
              'https://3gimg.qq.com/visual/lbs_gl_demo/image_tiles_layers/' +
              z +
              '/' +
              x +
              '_' +
              y +
              '.png';
            return url;
          },
          tileSize: 256, //ç“¦ç‰‡åƒç´ å°ºå¯¸
          minZoom: 14, //æ˜¾ç¤ºè‡ªå®šä¹‰ç“¦ç‰‡çš„æœ€å°çº§åˆ«
          maxZoom: 16, //æ˜¾ç¤ºè‡ªå®šä¹‰ç“¦ç‰‡çš„æœ€å¤§çº§åˆ«
          visible: true, //æ˜¯å¦å¯è§
          zIndex: 5000, //å±‚çº§é«˜åº¦ï¼ˆzè½´ï¼‰
          opacity: 0.95, //å›¾å±‚é€æ˜åº¦ï¼š1ä¸é€æ˜ï¼Œ0ä¸ºå…¨é€æ˜
          map: map, //è®¾ç½®å›¾å±‚æ˜¾ç¤ºåˆ°å“ªä¸ªåœ°å›¾å®ä¾‹ä¸­
        });

        //åˆå§‹åŒ–marker
        var marker = new TMap.MultiMarker({
          id: 'marker-layer',
          map: map,
          styles: {
            marker: new TMap.MarkerStyle({
              width: 20,
              height: 35,
              anchor: { x: 16, y: 32 },
              src: 'http://106.12.154.161/images/å››åˆé™¢.png',
              // è®¾ç½®æ–‡æ¡ˆåç§»
              offset: { x: 0, y: 15 },
            }),
          },
          // ä¸ªæ•°
          geometries: geometriesList,
        });

        // æ·»åŠ  marker
        //   markerLayer.add({
        //     position: evt.latLng,
        //   });

        var markerID = document.getElementById('markerId');
        var position = document.getElementById('position');

        //åˆå§‹åŒ–infoWindow ä¿¡æ¯çª—å£
        // var infoWindow = new TMap.InfoWindow({
        //   map: map,
        //   position: new TMap.LatLng(26.870355, 100.239704),
        //   offset: { x: 0, y: -32 }, //è®¾ç½®ä¿¡æ¯çª—ç›¸å¯¹positionåç§»åƒç´ 
        //   content: `
        //             <div class="markerContet">
        //             <div id="sign">ä»‹ç»</div>
        //             <div>å¯¼èˆª</div>
        //             <div>å…¨æ™¯</div>
        //             <div>è¯­éŸ³</div>
        //             </div>
        //             `,
        //   // "<div><img src='https://mapapi.qq.com/web/lbs/javascriptGL/demo/img/em.jpg'><p>Hello World!</p></div>",
        // });
        // infoWindow.close(); //åˆå§‹å…³é—­ä¿¡æ¯çª—å…³é—­
        var eventClick = function (evt) {
          console.log('123', evt);
          // ç½‘é¡µç«¯
          // window.parent.postMessage('hello, Taro', '*');
          wx.miniProgram.postMessage({
            // å‘å°ç¨‹åºå‘é€æ¶ˆæ¯
            data: {
              title: '123',
              // path: `${
              //   MINI_PROGRAME_URL_MAP['good']
              // }?src=${getUrlPrefix()}/good/${goodDetail.id}`,
              path: `/pages/web-view/index`,
              // imageUrl: goodDetail?.good_img,
            },
          });
          // infoWindow.open(); //æ‰“å¼€ä¿¡æ¯çª—
          // infoWindow.setPosition(evt.geometry.position); //è®¾ç½®ä¿¡æ¯çª—ä½ç½®
          // infoWindow.setContent(evt.geometry.position.toString()); //è®¾ç½®ä¿¡æ¯çª—å†…å®¹

          // markerID.innerHTML = 'markerID:' + evt.geometry.id;
          // position.innerHTML =
          //   'å½“å‰markerä½ç½®ï¼š' + evt.geometry.position.toString();
        };
        var eventClick1 = function (evt) {
          console.log('456', evt);
        };
        marker.on('click', eventClick);

        infoWindow.on('click', eventClick1);

        new TMap.event.addListener(infoWindow, 'domready', function () {
          console.log('domready');
          // window.document
          //   .getElementById('sign')
          //   .addEventListener('click', this.goSign, false);
        });
      };

      initPage();
    </script>
  </body>
</html>
